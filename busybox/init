#!/bin/sh

mkdir -p /dev/pts
mkdir -p /etc/dropbear
mkdir -p /home
mkdir -p /proc
mkdir -p /root
mkdir -p /sys
mkdir -p /var/log

mount -t devpts devpts /dev/pts
mount -t proc   proc   /proc
mount -t sysfs  sysfs  /sys

mdev -s

for mod in /sys/bus/pci/devices/*/modalias; do modprobe "$(cat "$mod")" 2>/dev/null; done

ifconfig eth0 up
ip addr add 192.168.100.90/24 dev eth0
echo "nameserver 192.168.100.100" > /etc/resolv.conf

echo "root:x:0:" > /etc/group
echo "root:x:0:0:root:/root:/bin/sh" > /etc/passwd
echo "root:root" | chpasswd 2> /dev/null

USERNAME="takumi"

addgroup -g 1000 "${USERNAME}"
adduser -u 1000 -G "${USERNAME}" -s /bin/sh -h "/home/${USERNAME}" -D "${USERNAME}"
echo "${USERNAME}:${USERNAME}" | chpasswd 2> /dev/null

mkdir -m 0700 "/home/${USERNAME}/.ssh"
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB/qb8XxUTnQQgEYF3W2ZaVu8VWqzoYNxpKA/FOFDhoG admin" > "/home/${USERNAME}/.ssh/authorized_keys"
chown -R 1000:1000 "/home/${USERNAME}"

chmod u+s /bin/su

wget http://boot.internal/rpi/boot/rootfs.tar.xz
mkdir -p /mnt
tar -xf /tmp/rootfs.tar.xz -C /mnt -p --numeric-owner --acls --xattrs

# exec /sbin/dropbear -R -F -E
exec /sbin/switch_root /mnt /sbin/init
